#!/bin/sh

RUNTIME=600
SLEEP="/bin/sleep"

prog=$(basename $0)

main () {
    tmp=$(mktemp -td cui-XXXXXXXXXX)
    trap "rm -rf $tmp" EXIT

    (
    cd "$tmp"
    log "building UI job in $PWD"

    submit > ./submit

    log "submitting UI job"
    condor_submit ./submit > /dev/null

    log "waiting for UI job to start running"
    jobid=$(monitor log)

    log "connecting to UI job"
    condor_ssh_to_job "$jobid"
    )
    return $?
}

monitor () {
    log="$1"
    tail -f "$log" | while read line; do
        case "$line" in
            *"Job submitted from host:"*)
                jobid=$(getjobid $line)
                log "job $jobid submitted"
                ;;
            *"Job executing on host:"*)
                log "job $jobid running"
                echo "$jobid"
                return
                ;;
        esac
    done
}

getjobid () {
    # Log lines look like:
    # 001 (030.000.000) 02/02 12:31:01 Job executing on host: <144.92.180.98:46823>
    set -- $*
    jobid="$2"
    jobid="${jobid#(}"; jobid="${jobid%)}"
    echo "$jobid"
}

submit () {
    cat <<EOF
universe                 =  vanilla
notification             =  never
executable               =  $SLEEP
arguments                =  "$RUNTIME"
log                      =  log
transfer_executable      =  false
should_transfer_files    =  true
when_to_transfer_output  =  on_exit

queue
EOF
}

log () {
    echo "$*" 1>&2
}

usage () {
    echo "Usage: $prog [options]"
}

while getopts dhv ARG; do
    case "${ARG}" in
        h) usage; exit 0;;
        *) usage; exit 1;;
    esac
done
shift $(($OPTIND - 1))

main

exit $?
